name: Publish to Google Play Console

on:
  workflow_dispatch:
    inputs:
      developer:
        description: 'Developer account'
        required: true
        type: choice
        options:
          - 01_giggle_game
          - 02_playpal_creations
          - 03_olaf
          - 04_good_kids
          - 05_apocalypse_never
          - 06_atomizer
          - 07_okkyes
          - 08_insightful_apps
          - 09_build_deploy_labs
          - 10_micho
          - 11_playtime_programmers
      app_name:
        description: 'App name'
        required: true
        type: string
      release_track:
        description: 'Release track'
        required: true
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

jobs:
  build-and-publish:
    name: Build and Publish to GPC
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v4
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            wget \
            unzip \
            xz-utils \
            zip \
            libglu1-mesa \
            build-essential

      - name: Setup Android signing
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "Setting up signing keys..."
            mkdir -p android/app
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
            
            APP_DIR="${{ github.workspace }}/${{ github.event.inputs.developer }}/${{ github.event.inputs.app_name }}"
            if [ -d "$APP_DIR/android" ]; then
              mkdir -p "$APP_DIR/android"
              cat > "$APP_DIR/android/key.properties" << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../upload-keystore.jks
          EOF
            fi
            echo "âœ… Signing keys configured"
          fi

      - name: Build signed AAB
        run: |
          APP_DIR="${{ github.workspace }}/${{ github.event.inputs.developer }}/${{ github.event.inputs.app_name }}"
          cd "$APP_DIR"
          
          flutter clean
          flutter pub get
          flutter build appbundle --release
          
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ… AAB built successfully"
            mkdir -p "${{ github.workspace }}/store_assets/${{ github.event.inputs.developer }}/${{ github.event.inputs.app_name }}"
            cp "build/app/outputs/bundle/release/app-release.aab" \
               "${{ github.workspace }}/store_assets/${{ github.event.inputs.developer }}/${{ github.event.inputs.app_name }}/app-release.aab"
          else
            echo "âŒ AAB build failed"
            exit 1
          fi

      - name: Generate store assets
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        run: |
          pip install Pillow
          
          DEVELOPER="${{ github.event.inputs.developer }}"
          APP_NAME="${{ github.event.inputs.app_name }}"
          
          mkdir -p "store_assets/$DEVELOPER/$APP_NAME/icons"
          mkdir -p "store_assets/$DEVELOPER/$APP_NAME/graphics"
          mkdir -p "store_assets/$DEVELOPER/$APP_NAME/screenshots"
          mkdir -p "store_assets/$DEVELOPER/$APP_NAME/descriptions"
          
          # Generate icon
          python3 << 'EOF'
          from PIL import Image, ImageDraw, ImageFont
          import os
          developer = os.environ['DEVELOPER']
          app_name = os.environ['APP_NAME']
          icon = Image.new('RGB', (512, 512), color='#2196F3')
          draw = ImageDraw.Draw(icon)
          try:
              font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 60)
          except:
              font = ImageFont.load_default()
          text = app_name.replace('_', ' ').title()
          bbox = draw.textbbox((0, 0), text, font=font)
          text_width = bbox[2] - bbox[0]
          position = ((512 - text_width) // 2, 200)
          draw.text(position, text, fill='white', font=font)
          icon.save(f"store_assets/{developer}/{app_name}/icons/icon-512.png")
          print("âœ… Icon generated")
          EOF
          
          # Generate feature graphic
          python3 << 'EOF'
          from PIL import Image, ImageDraw, ImageFont
          import os
          developer = os.environ['DEVELOPER']
          app_name = os.environ['APP_NAME']
          graphic = Image.new('RGB', (1200, 500), color='#4CAF50')
          draw = ImageDraw.Draw(graphic)
          try:
              font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 80)
          except:
              font = ImageFont.load_default()
          text = app_name.replace('_', ' ').title()
          bbox = draw.textbbox((0, 0), text, font=font)
          text_width = bbox[2] - bbox[0]
          position = ((1200 - text_width) // 2, 200)
          draw.text(position, text, fill='white', font=font)
          graphic.save(f"store_assets/{developer}/{app_name}/graphics/feature-graphic.png")
          print("âœ… Feature graphic generated")
          EOF
          
          # Generate descriptions
          cat > "store_assets/$DEVELOPER/$APP_NAME/descriptions/short.txt" << DESC
          $(echo "$APP_NAME" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++)$i=toupper(substr($i,1,1)) substr($i,2)}1') - Your daily companion
          DESC
          
          cat > "store_assets/$DEVELOPER/$APP_NAME/descriptions/full.txt" << DESC
          # $(echo "$APP_NAME" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++)$i=toupper(substr($i,1,1)) substr($i,2)}1')
          
          ## About
          $(echo "$APP_NAME" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++)$i=toupper(substr($i,1,1)) substr($i,2)}1') is a powerful and intuitive app designed to enhance your daily experience.
          
          ## Features
          - Clean and modern interface
          - Fast and responsive
          - Offline functionality
          - Regular updates
          
          Download now and experience the difference!
          DESC
          
          echo "âœ… Store assets generated"

      - name: Upload to Google Play Console
        if: env.GPC_ENABLED == 'true'
        env:
          GPC_SERVICE_ACCOUNT_JSON: ${{ secrets.GPC_SERVICE_ACCOUNT_JSON }}
          GPC_PACKAGE_NAME: ${{ secrets.GPC_PACKAGE_NAME }}
          GPC_ENABLED: ${{ secrets.GPC_SERVICE_ACCOUNT_JSON != '' && 'true' || 'false' }}
        run: |
          if [ "$GPC_ENABLED" = "true" ]; then
            echo "ðŸ“¤ Uploading to Google Play Console..."
            echo "âš ï¸  GPC upload requires additional setup"
            echo "ðŸ’¡ See GPC_API_SETUP.md for instructions"
            # TODO: Implement GPC API upload
            # This requires:
            # 1. Google Play Console API setup
            # 2. Service account JSON
            # 3. fastlane or google-play-developer-api
          else
            echo "âš ï¸  GPC upload skipped (secrets not configured)"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: publish-package-${{ github.event.inputs.developer }}-${{ github.event.inputs.app_name }}
          path: |
            store_assets/${{ github.event.inputs.developer }}/${{ github.event.inputs.app_name }}/
          retention-days: 90

      - name: Summary
        run: |
          echo "### Publish to GPC Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Developer:** ${{ github.event.inputs.developer }}" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ github.event.inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Track:** ${{ github.event.inputs.release_track }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Completed Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Signed AAB built" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Store assets generated" >> $GITHUB_STEP_SUMMARY
          echo "- â³ GPC upload (requires API setup)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download package from: Actions â†’ Artifacts" >> $GITHUB_STEP_SUMMARY

